<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>MINOR_ISL</title>

<meta http-equiv="Access-Control-Allow-Origin" content="*">
<meta http-equiv="Access-Control-Allow-Methods" content="GET">

<link rel="stylesheet"
    href="css_cwasa.css" />
<script type="text/javascript"
    src="script_cwasa.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<script language="javascript">

CWASA.getLogger("Avatar", "info");

function playURL(surl) {
	CWASA.playSiGMLURL(surl);
}

function playText(stext) {
	CWASA.playSiGMLText(stext);
}

CWASA.addHook("status", addStatus);

function addStatus(evt) {
	var elt = document.getElementById("myStatusLog");
	var msg = evt.msg;
	if (evt.av != "*") {
		msg = "[av" + evt.av + "] " + msg;
	}
	elt.value = elt.value + msg + "\n";
}

CWASA.addHook("sigmlloading", startJSON);
CWASA.addHook("sigmlsign", writeJSON);
CWASA.addHook("sigmlloaded", endJSON);
var signSeq = 0;

function startJSON(evt) {
	var elt = document.getElementById("JSONText");
	if (elt) {
		elt.value = "[\n";
		signSeq = 0;
	}
}

function writeJSON(evt) {
	var elt = document.getElementById("JSONText");
	if (elt) {
		if (signSeq > 0) elt.value += ",\n"
		signSeq++;
		elt.value += JSON.stringify(evt.msg);
	}
}

function endJSON(evt) {
	var elt = document.getElementById("JSONText");
	if (elt) {
		elt.value += "\n]\n";
	}
}

CWASA.addHook("avatarfps", setFPS, 0);

function setFPS(evt) {
	var elt = document.getElementById("myFPS");
	elt.value = evt.msg.toFixed(2);
}

CWASA.addHook("avatarsign", setSignFrame, 0);

function setSignFrame(evt) {
	var msg = evt.msg;
	var elt = document.getElementById("mySF");
	elt.value = (msg.s+1)+"/"+(msg.f+1);
	elt = document.getElementById("myGloss");
	elt.value = msg.g;
}

</script>

</head>

<body onload="CWASA.init({avSettings:{initCamera:[0.00,0.53,2.06,-12.50,18.00,30.00,-1.00,-1.00],initSpeed:-1},useClientConfig:true});">

<!--================================================================-->
<h3 align="center" >MINOR</h3>
<h4 align="center" >Text direct access to CWASA using ISL</h4>
<hr/>

<!-- CWA signing avatar panel 0 -->
<!--================================================================-->
<div class="CWASAPanel av0" align="center" ></div>
<!--================================================================-->
<hr/>
<p align="center">
<span class="CWASAProgress av0"></span>
<hr/>
<p align="center">

	
<span style="font-size: 90%;" >


<input id="mySF" class="txtSF" value="0/0" type="text" />
<input id="myGloss" class="txtGloss" value="[none]" type="text" />
<input id="myFPS" class="txtFPS" value="00.00" type="text" />
</span>
<hr/>
<div align="center">

<textarea id="myStatusLog"  class="statusLog" rows="6" >
</textarea>
<hr/>
</div>
<div align="center">

<br>
<!-- HTML -->
Upload audio file:<input type="file" id="musicFile">
<button onclick="executePython()">Execute Python on Uploaded File</button>
<audio id="musicPlayer" controls></audio>


Record live:
<button id="btnStart">START RECORDING</button>
&nbsp;&nbsp;&nbsp;&nbsp;
<button id="btnStop">STOP RECORDING</button>
<a id="downloadLink" style="display: none;"></a>
<div class="loader hidden"></div>
<script>  
let isRecording = false;
let mediaRecorder;
let chunks = [];

const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');

btnStart.addEventListener('click', startRecording);
btnStop.addEventListener('click', stopRecording);

function startRecording() {
  if (!isRecording) {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => {
          chunks.push(event.data);
        };
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.download = 'recording.webm';
          downloadLink.click();
          chunks = [];
        };
        mediaRecorder.start();
        isRecording = true;
      })
      .catch(error => {
        console.error(error);
      });
  }
}

function stopRecording() {
  if (isRecording) {
    mediaRecorder.stop();
    isRecording = false;
	executePython();
  }
}

const loader = document.querySelector('.loader');

// Add event listener to start button
btnStart.addEventListener('click', function() {
    loader.classList.remove('hidden'); 
});

window.addEventListener('load', function () {
    loader.classList.add('hidden');
});


function executePython() {
        $.ajax({
            url: 'http://127.0.0.1:5000/execute_python',
            type: 'POST',
            success: function(response) {
                alert('SUCCESS!!...Sign Language Generated:', response);
            },
            error: function(error) {
                alert('Error executing script:', error);
            }
        });
    }

function execute_python_txt() {
        $.ajax({
            url: 'http://127.0.0.1:5000/execute_python_txt',
            type: 'POST',
            success: function(response) {
                alert('SUCCESS!!...Sign Language Generated:', response);
            },
            error: function(error) {
                alert('Error executing script:', error);
            }
        });
    }


// function upload_music() {
//     var musicFile = document.getElementById("musicFile").files[0];
//     var formData = new FormData();
//     formData.append('music', musicFile);

//     fetch('/upload_music', {
//         method: 'POST',
//         body: formData
//     })
//     .then(response => {
//         if (response.ok) {
//             return response.json();
//         }
//         throw new Error('Network response was not ok.');
//     })
//     .then(data => {
//         console.log('Python function executed:', data);
//     })
//     .catch(error => {
//         console.error('Error executing Python function:', error);
//     });
// }

function saveTextAsFile() {

    var textToSave = document.getElementById("textInput").value;
    
    var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
    
    var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
    
    var fileNameToSaveAs = "input_text.txt";
    
    var downloadLink = document.createElement("a");
    
    downloadLink.download = fileNameToSaveAs;
    
    downloadLink.innerHTML = "Download File";
    
    downloadLink.href = textToSaveAsURL;
    
    downloadLink.onclick = destroyClickedElement;
    
    downloadLink.style.display = "none";
    
    document.body.appendChild(downloadLink);
    
    downloadLink.click();

    execute_python_txt()
    
    }
    
    function destroyClickedElement(event) {
    
    document.body.removeChild(event.target);
    
    }
    
    function clear_cache() {
        $.ajax({
            url: 'http://127.0.0.1:5000/clear_cache',
            type: 'POST',
            success: function(response) {
                console.log('Cache Data Cleared from Downloads:', response);
            },
            error: function(error) {
                console.log('Error executing script:', error);
            }
        });
    }
clear_cache()

const eventSource = new EventSource('http://127.0.0.1:5000/');

eventSource.onmessage = function (event) {
    console.log('Message from server:', event.data);
};


    </script>



<br>

<br>
<input id="myURL" class="txtSiGMLURL av0" value="welkom-ngt.sigml" type="text" />
<input type="button" value="Play" onclick='playURL(document.getElementById("myURL").value);' />
<input type="button" value="Stop" onclick='CWASA.stopSiGML();' />

<hr/>


</div>

<hr/>
<p>

</body>
</html>